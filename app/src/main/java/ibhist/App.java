/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package ibhist;

import com.google.inject.Guice;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import java.io.PrintStream;
import java.nio.charset.StandardCharsets;

import static ibhist.StringUtils.ANSI_GREEN;
import static ibhist.StringUtils.ANSI_RESET;

public class App {
    private static final Logger log = LogManager.getLogger(App.class.getSimpleName());

    /**
     * Command line application that processes different modes based on arguments:
     * - "hist": Historical data processing
     * - "day": ES day data processing
     * - "rt": Real-time data processing
     * - "repl": Interactive REPL mode
     * - No argument or blank: defaults to "day"
     *
     * @param args command line arguments
     */
    static void main(String[] args) {
        // Force console to UTF-8 - this works when launching directly from Windows Terminal not via gradle run
        try {
            new ProcessBuilder("cmd", "/c", "chcp", "65001", ">nul").inheritIO().start().waitFor();
            System.setOut(new PrintStream(System.out, true, StandardCharsets.UTF_8));
            System.out.println("Output charset: " + System.out.charset() + ANSI_GREEN + " ▲ ▼" + ANSI_RESET);
        } catch (Exception e) {}

        log.info("Java version: {}", System.getProperty("java.version"));
        var injector = Guice.createInjector(new AppModule());

        // Determine the command - default to "day" if no args or empty
        String command = (args.length == 0) ? "day" : args[0].toLowerCase().trim();
        log.info("ibhist '{}'", command);

        switch (command) {
            case "week" -> {
                var ibConnector = injector.getInstance(IBConnector.class);
                ibConnector.process(IBConnector.ConnectorAction.LATEST_WEEK);
            }
            case "hist" -> {
                var ibConnector = injector.getInstance(IBConnector.class);
                ibConnector.process(IBConnector.ConnectorAction.HISTORICAL);
            }
            case "day" -> {
                var ibConnector = injector.getInstance(IBConnector.class);
                ibConnector.process(IBConnector.ConnectorAction.ES_DAY);
            }
            case "rt" -> {
                var ibConnector = injector.getInstance(IBConnector.class);
                ibConnector.process(IBConnector.ConnectorAction.REALTIME);
            }
            case "repl" -> {
                injector.getInstance(Repl.class).run();
            }
            default -> {
                log.error("Unknown command: '{}'.", command);
                System.err.println("Usage: java ibhist.App [hist|day|rt|repl]");
                System.exit(1);
            }
        }
    }
}
